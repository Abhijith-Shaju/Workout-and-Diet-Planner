<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitLife Planner Pro & FitBot Assistant</title>
    <style>
        /* --- Root Variables --- */
        :root {
            --primary: #2c3e50; /* Dark Blue-Gray */
            --secondary: #3498db; /* Bright Blue */
            --light: #ecf0f1; /* Light Gray */
            --danger: #e74c3c; /* Red */
            --success: #2ecc71; /* Green */
            --warning: #f39c12; /* Orange */
            --info: #007bff; /* Primary Blue (for chatbot) */
            --chat-bg: #ffffff;
            --chat-bubble-user: var(--info);
            --chat-bubble-bot: #e9ecef;
            --sidebar-width: 220px;
            --border-radius: 8px;
            --box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* --- Basic Reset & Body --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--light);
            display: flex;
            min-height: 100vh;
        }

        /* --- Planner Layout --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--primary);
            padding: 25px 15px;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            color: white;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
            font-weight: 600;
        }

        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            height: 100vh;
        }

        .nav {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .nav button {
            padding: 12px 15px;
            border: none;
            border-radius: var(--border-radius);
            background: var(--secondary);
            color: white;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            text-align: left;
            font-size: 1rem;
        }
        
        .nav button:hover {
            background-color: #2980b9;
            transform: translateX(3px);
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
        }
        
        .card h2, .card h3 {
            color: var(--primary);
            margin-bottom: 20px;
        }

        /* --- Planner Specific Components --- */
        .top-layout-container {
            display: flex;
            gap: 25px;
            margin-bottom: 25px;
            align-items: flex-start;
        }
        
        .today-plan-card {
            flex: 1;
            min-width: 250px;
        }
        
        .today-plan-card h3 {
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .today-plan-card h3 span {
            color: var(--secondary);
            font-weight: 600;
        }
        
        #todaysWorkoutContent {
            max-height: 245px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        #todaysWorkoutContent .exercise-item {
            padding: 12px;
            margin: 0 0 8px 0;
        }
        
        #todaysWorkoutContent .exercise-details h4 {
            font-size: 1rem;
        }
        
        #todaysWorkoutContent .item-actions {
            gap: 8px;
        }
        
        #todaysWorkoutContent .action-btn {
            padding: 4px 8px;
            font-size: 0.8rem;
        }
        
        #todaysWorkoutContent .complete-checkbox {
            margin-right: 5px;
        }

        .chart-container {
            flex: 2;
            min-width: 300px;
            position: relative;
            padding-bottom: 10px;
        }
        
        .chart {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 200px;
            margin-top: 15px;
            padding: 0 10px 25px 10px;
            border-bottom: 1px solid #ccc;
            position: relative;
        }
        
        .bar-wrapper {
            width: 12%;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            position: relative;
            cursor: pointer;
        }
        
        .bar {
            width: 70%;
            background: var(--secondary);
            border-radius: 5px 5px 0 0;
            transition: height 0.5s ease-out, background-color 0.3s ease;
            margin-top: auto;
            position: relative;
            min-height: 2px;
            height: 0%;
        }
        
        .bar-wrapper:hover .bar {
            background-color: #2980b9;
        }
        
        .bar-value {
            position: absolute;
            top: -20px;
            width: 100%;
            text-align: center;
            font-size: 11px;
            color: var(--primary);
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        
        .bar-wrapper:hover .bar-value {
            opacity: 1;
        }
        
        .bar-label {
            position: absolute;
            bottom: 5px;
            left: 0;
            width: 100%;
            font-size: 12px;
            color: var(--primary);
            text-align: center;
        }

        /* Chart Detail Popup */
        .chart-detail-popup {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.98);
            border: 1px solid var(--secondary);
            border-radius: var(--border-radius);
            padding: 10px 15px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.25);
            font-size: 0.85rem;
            max-width: 260px;
            z-index: 50;
            color: var(--primary);
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, visibility 0s linear 0.3s, transform 0.3s ease;
        }
        
        .chart-detail-popup.visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: translateY(0);
            transition: opacity 0.3s ease, visibility 0s linear 0s, transform 0.3s ease;
        }
        
        .chart-detail-popup h5 {
            margin: 0 0 8px 0;
            color: var(--secondary);
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 5px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .chart-detail-popup ul {
            list-style: none;
            padding-left: 0;
            margin: 0;
            max-height: 120px;
            overflow-y: auto;
        }
        
        .chart-detail-popup li {
            margin-bottom: 5px;
            padding: 3px 0;
            border-bottom: 1px dotted #eee;
            line-height: 1.3;
            word-break: break-word;
        }
        
        .chart-detail-popup li:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .chart-detail-popup em {
            color: #777;
        }

        /* Workout Accordion Styles */
        #weeklyWorkouts .weekday-section h3 {
            cursor: pointer;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--light);
            padding-bottom: 8px;
            user-select: none;
        }
        
        #weeklyWorkouts .weekday-section h3::after {
            content: '▼';
            font-size: 0.8em;
            margin-left: 10px;
            transition: transform 0.3s ease;
        }
        
        #weeklyWorkouts .weekday-section.open h3 {
            margin-bottom: 20px;
        }
        
        #weeklyWorkouts .weekday-section.open h3::after {
            transform: rotate(180deg);
        }
        
        #weeklyWorkouts .weekday-exercises {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        
        #weeklyWorkouts .weekday-section.open .weekday-exercises {
            max-height: 1000px;
            transition: max-height 0.6s ease-in;
        }

        /* General Item Styles */
        .exercise-item, .meal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border-left: 5px solid var(--secondary);
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .exercise-item:last-child, .meal-item:last-child {
            margin-bottom: 0;
        }
        
        .exercise-item.completed {
            background: #e8f5e9;
            border-left-color: var(--success);
        }
        
        .exercise-item.completed .exercise-details h4,
        .exercise-item.completed .exercise-details p {
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        .exercise-details, .meal-details {
            flex-grow: 1;
            margin-right: 15px;
            overflow: hidden;
        }
        
        .exercise-details h4, .meal-details h4 {
            margin-bottom: 5px;
            color: var(--primary);
            font-size: 1.05rem;
            word-break: break-word;
        }
        
        .exercise-details p, .meal-details p {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 3px;
            line-height: 1.4;
            word-break: break-word;
        }
        
        .exercise-details small {
            font-size: 0.8rem;
            color: var(--success);
            display: block;
            margin-top: 5px;
        }
        
        .meal-details h4 span {
            font-weight: normal;
            font-size: 0.9em;
            color: #666;
        }
        
        .item-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
        }
        
        .action-btn {
            border: none;
            padding: 6px 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.85rem;
            transition: opacity 0.3s, transform 0.1s;
            color: white;
        }
        
        .action-btn:hover {
            opacity: 0.85;
        }
        
        .action-btn:active {
            transform: scale(0.95);
        }
        
        .edit-btn {
            background: var(--warning);
        }
        
        .delete-btn {
            background: var(--danger);
        }
        
        .complete-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--success);
            margin-right: 5px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            margin-top: 5px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
            background-color: #fff;
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        input[type="date"] {
            min-height: 40px;
        }
        
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            font-size: 1rem;
            font-weight: 500;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-secondary {
            background: #bdc3c7;
            color: var(--primary);
        }
        
        .btn-secondary:hover {
            background-color: #a7acaf;
        }

        /* Progress Stats Styles */
        #progressStats h4 {
            margin-top: 15px;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        #progressStats h4:first-child {
            margin-top: 0;
        }
        
        #progressStats p {
            margin-bottom: 8px;
            color: #333;
            font-size: 0.95rem;
        }
        
        #progressStats strong {
            color: var(--primary);
            font-weight: 600;
        }
        
        hr {
            border: none;
            border-top: 1px solid #eee;
            margin: 20px 0;
        }

        /* --- Chatbot Styles --- */
        #chat-toggle-button {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            background-color: var(--info);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease, transform 0.3s ease;
            z-index: 999;
        }
        
        #chat-toggle-button:hover {
            background-color: #0056b3;
            transform: scale(1.1);
        }

        #chat-widget {
            position: fixed;
            bottom: 100px;
            right: 25px;
            width: 350px;
            height: 500px;
            background-color: var(--chat-bg);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            overflow: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
            z-index: 1000;
        }
        
        #chat-widget.active {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        #chat-header {
            background-color: var(--info);
            color: white;
            padding: 15px;
            font-weight: bold;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }
        
        #close-chat {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            font-weight: bold;
        }
        
        #close-chat:hover {
            opacity: 0.8;
        }

        #chat-body {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Chat Message Bubbles */
        .message {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.4;
            white-space: pre-wrap;
        }
        
        .user-message {
            background-color: var(--chat-bubble-user);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        
        .bot-message {
            background-color: var(--chat-bubble-bot);
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        
        .typing-indicator {
            font-style: italic;
            color: #6c757d;
            align-self: flex-start;
            padding: 5px 15px;
            font-size: 0.9em;
        }

        #chat-input-area {
            display: flex;
            padding: 10px;
            border-top: 1px solid #dee2e6;
            background-color: var(--chat-bg);
            align-items: flex-end;
        }
        
        #userInput {
            flex-grow: 1;
            border: 1px solid #ced4da;
            border-radius: 20px;
            padding: 10px 15px;
            margin-right: 10px;
            font-size: 1em;
            resize: none;
            height: 40px;
            line-height: 1.4;
            overflow-y: hidden;
        }
        
        #userInput:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, .25);
        }
        
        #send-button {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease;
            flex-shrink: 0;
        }
        
        #send-button:hover {
            background-color: #218838;
        }

        /* --- Responsive Styles --- */
        @media (max-width: 992px) {
            .top-layout-container {
                flex-direction: column;
            }
            
            .today-plan-card, .chart-container {
                flex: none;
                width: 100%;
                min-width: unset;
            }
            
            #todaysWorkoutContent {
                max-height: 250px;
            }
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
                height: auto;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: static;
                flex-direction: row;
                justify-content: space-around;
                padding: 10px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }
            
            .sidebar h2 {
                display: none;
            }
            
            .nav {
                flex-direction: row;
                gap: 5px;
                width: 100%;
                justify-content: center;
            }
            
            .nav button {
                flex: 1;
                text-align: center;
                font-size: 0.85rem;
                padding: 8px;
            }
            
            .main-content {
                margin-left: 0;
                padding: 15px;
                height: auto;
                min-height: calc(100vh - 60px);
                overflow-y: visible;
            }
            
            .card {
                padding: 20px;
            }
            
            .card h2, .card h3 {
                font-size: 1.3rem;
            }
            
            .top-layout-container {
                gap: 15px;
            }
            
            .today-plan-card h3 {
                font-size: 1.1rem;
            }
            
            .chart-container {
                padding-bottom: 20px;
            }
            
            .exercise-item, .meal-item {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
                padding: 12px;
            }
            
            .item-actions {
                width: 100%;
                justify-content: flex-end;
                padding-top: 10px;
                border-top: 1px solid #eee;
                margin-top: 5px;
            }
            
            .action-btn {
                font-size: 0.8rem;
                padding: 5px 10px;
            }
            
            .complete-checkbox {
                margin-right: auto;
            }
            
            #todaysWorkoutContent .item-actions,
            #todaysWorkoutContent .action-btn,
            #todaysWorkoutContent .complete-checkbox {
                justify-content: flex-end;
                padding-top: 10px;
                border-top: 1px solid #eee;
                margin-top: 5px;
                font-size: 0.8rem;
                padding: 5px 10px;
                margin-right: auto;
            }

            .chart {
                height: 180px;
                padding-bottom: 30px;
            }
            
            .bar-wrapper {
                width: 13%;
            }
            
            .bar-label {
                font-size: 11px;
            }
            
            .chart-detail-popup {
                max-width: 180px;
                font-size: 0.8rem;
                padding: 8px 12px;
                top: 5px;
                left: 5px;
            }
            
            .chart-detail-popup h5 {
                font-size: 0.85rem;
            }
            
            #chat-widget {
                width: calc(100% - 40px);
                height: 70vh;
                right: 20px;
                bottom: 90px;
            }
            
            #chat-toggle-button {
                width: 50px;
                height: 50px;
                font-size: 24px;
                bottom: 20px;
                right: 20px;
            }
        }

        @media (max-width: 480px) {
            .nav button {
                font-size: 0.75rem;
                padding: 6px 4px;
            }
            
            .card h2, .card h3 {
                font-size: 1.2rem;
            }
            
            .today-plan-card h3 {
                font-size: 1rem;
            }
            
            .form-buttons {
                flex-direction: column;
                gap: 8px;
            }
            
            .form-buttons .btn {
                width: 100%;
            }
            
            .chart {
                height: 160px;
            }
            
            .bar-label {
                font-size: 10px;
            }
            
            .exercise-details h4, .meal-details h4 {
                font-size: 1rem;
            }
            
            .exercise-details p, .meal-details p {
                font-size: 0.85rem;
            }
            
            #chat-widget {
                width: calc(100% - 20px);
                right: 10px;
            }
            
            #chat-toggle-button {
                bottom: 15px;
                right: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Planner Sidebar -->
    <nav class="sidebar">
        <h2>FitLife Pro</h2>
        <nav class="nav">
            <button data-section="workout">🏋️ Workout</button>
            <button data-section="meal">🍏 Nutrition</button>
            <button data-section="progress">📈 Progress</button>
        </nav>
    </nav>

    <!-- Planner Main Content Area -->
    <div class="main-content">
        <!-- Workout Section -->
        <div id="workout" class="section active">
            <!-- Container for Today's Plan and Chart -->
            <div class="top-layout-container">
                <!-- Today's Workout Plan Section -->
                <div id="todaysWorkoutPlan" class="card today-plan-card">
                    <h3>Today's Plan (<span id="todayDayName"></span>)</h3>
                    <div id="todaysWorkoutContent">
                        <p><em>Loading today's plan...</em></p>
                    </div>
                </div>
                
                <!-- Chart Section -->
                <div class="card chart-container">
                    <h3>Weekly Activity (Completed Minutes)</h3>
                    <div id="chartWorkoutDetail" class="chart-detail-popup">Click a bar...</div>
                    <div class="chart" id="workoutChart"></div>
                </div>
            </div>
            
            <!-- Form Section -->
            <div class="card form">
                <h3 id="formTitle">Add Exercise</h3>
                <form id="workoutForm">
                    <input type="hidden" id="editWorkoutId">
                    <div class="form-group">
                        <label for="weekdaySelect">Weekday:</label>
                        <select id="weekdaySelect" required>
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                            <option value="Saturday">Saturday</option>
                            <option value="Sunday">Sunday</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="exerciseName">Exercise Name:</label>
                        <input type="text" id="exerciseName" placeholder="e.g., Bench Press" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="exerciseDuration">Duration (minutes):</label>
                        <input type="number" id="exerciseDuration" placeholder="e.g., 30" min="1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="exerciseSets">Sets/Reps:</label>
                        <input type="text" id="exerciseSets" placeholder="e.g., 3 sets of 10 reps" required>
                    </div>
                    
                    <div class="form-buttons">
                        <button type="submit" id="saveWorkoutBtn" class="btn btn-primary">Add Exercise</button>
                        <button type="button" id="cancelEditWorkoutBtn" class="btn btn-secondary" style="display: none;">Cancel Edit</button>
                    </div>
                </form>
            </div>
            
            <!-- Weekly Workouts Accordion Section -->
            <div id="weeklyWorkouts"></div>
        </div> <!-- END of #workout section -->

        <!-- Meal Section -->
        <div id="meal" class="section">
            <div class="card form">
                <h3>Log Meal</h3>
                <form id="mealForm">
                    <input type="hidden" id="editMealId">
                    <div class="form-group">
                        <label for="mealName">Meal Name:</label>
                        <input type="text" id="mealName" placeholder="e.g., Chicken Salad" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="mealCalories">Calories:</label>
                        <input type="number" id="mealCalories" placeholder="e.g., 450" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="mealProtein">Protein (g):</label>
                        <input type="number" id="mealProtein" placeholder="e.g., 30" min="0" step="0.1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="mealDate">Date:</label>
                        <input type="date" id="mealDate" required>
                    </div>
                    
                    <div class="form-buttons">
                        <button type="submit" id="saveMealBtn" class="btn btn-primary">Add Meal</button>
                        <button type="button" id="cancelEditMealBtn" class="btn btn-secondary" style="display: none;">Cancel Edit</button>
                    </div>
                </form>
            </div>
            
            <div class="card">
                <h3>Meal Log</h3>
                <div id="mealEntries"></div>
            </div>
        </div>

        <!-- Progress Section -->
        <div id="progress" class="section">
            <div class="card">
                <h2>Progress Overview</h2>
                <div id="progressStats"></div>
            </div>
            
            <div class="card chart-container">
                <h3>Workout Minutes This Week</h3>
                <div id="chartProgressDetail" class="chart-detail-popup">Click a bar...</div>
                <div class="chart" id="progressWorkoutChart"></div>
            </div>
        </div>
    </div> <!-- END of .main-content -->

    <!-- Chatbot HTML Elements (Positioned Fixed) -->
    <button id="chat-toggle-button" title="Open FitBot Assistant">💪</button>

    <div id="chat-widget">
        <div id="chat-header">
            <span>FitBot Assistant</span>
            <button id="close-chat" title="Close Chat">✕</button>
        </div>
        <div id="chat-body">
            <!-- Initial Bot Message -->
            <div class="bot-message message">
                Hello! I'm FitBot. How can I help you with your fitness goals today? Ask me about workout plans, diet tips, or anything fitness-related!
            </div>
            <!-- Dynamic Messages Appear Here -->
        </div>
        <div id="chat-input-area">
            <textarea id="userInput" placeholder="Ask FitBot..." rows="1"></textarea>
            <button id="send-button" title="Send Message">➤</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ==================================================
            // --- FitBot Configuration ---
            // ==================================================

            // --- WARNING --- WARNING --- WARNING ---
            // ---          API KEY SECURITY           ---
            // Embedding API keys directly in client-side JavaScript is HIGHLY INSECURE.
            // Anyone can view your page source and steal your key.
            // This leads to unauthorized use and potentially significant costs.
            //
            // ** FOR PRODUCTION, YOU MUST USE A BACKEND PROXY: **
            // 1. Create a simple server (Node.js, Python, etc.).
            // 2. Store your API key securely on the server (e.g., environment variable).
            // 3. Create an endpoint on your server (e.g., /api/chat).
            // 4. Your frontend sends messages to YOUR server's endpoint.
            // 5. Your server receives the message, adds the API key, calls the Gemini API,
            //    and sends the response back to the frontend.
            //
            // This key is included here ONLY for local demonstration purposes.
            // Replace "YOUR_API_KEY_HERE" with your actual key for local testing.
            // DO NOT DEPLOY THIS CODE WITH THE KEY EMBEDDED.
            const GEMINI_API_KEY = "API_KEY_HERE"; // <<< --- REPLACE WITH YOUR KEY FOR LOCAL TESTING ONLY
            // --- END SECURITY WARNING ---

            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
            const MAX_HISTORY_TURNS = 5;

            const systemPrompt = `
You are FitBot, a friendly fitness assistant chatbot. You answer user questions related to workouts, diet, and body transformation tips in a supportive and motivational tone. You are an expert in strength training, fat loss, muscle gain, personalized workout plans (beginner to advanced, home/gym), nutritional guidance (bulking, cutting, maintenance), calorie/macro tracking, supplements (creatine, whey, etc.), motivation, and recovery.

Your personality is supportive, motivational, non-judgmental, and encouraging, like a personal fitness coach. You make users feel empowered.

Your responses should be:
* Clear and easy to understand.
* Actionable with realistic steps or examples (e.g., list specific exercises, sets, reps for workouts; suggest specific meal ideas for diets).
* Motivational and positive.
* Tailored based on user goals, experience, equipment etc., if provided.
* Formatted cleanly: Do NOT use markdown like asterisks (*) or hash (#). Use plain text and line breaks for structure.
* Relatively concise where appropriate but provide necessary detail.

Do NOT diagnose medical issues or give medical advice. Encourage users to consult a healthcare professional for health concerns.

Do NOT answer out-of-domain questions (politics, history, general knowledge unrelated to fitness). If asked, politely state you specialize in fitness and redirect to their health goals.

End responses with a short motivational note like "You've got this!", "Stay consistent!", or "Keep crushing it!".
`.trim();

            // --- Chatbot State ---
            let chatHistory = [];

            // --- Chatbot DOM Elements ---
            const chatToggleButton = document.getElementById('chat-toggle-button');
            const chatWidget = document.getElementById('chat-widget');
            const closeChatButton = document.getElementById('close-chat');
            const chatBody = document.getElementById('chat-body');
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('send-button');

            // ==================================================
            // --- FitLife Planner Elements & State ---
            // ==================================================
            const sidebarNav = document.querySelector('.sidebar .nav');
            const sections = document.querySelectorAll('.main-content .section');
            const workoutSectionContainer = document.getElementById('workout');
            const workoutForm = document.getElementById('workoutForm');
            const mealForm = document.getElementById('mealForm');
            const weeklyWorkoutsContainer = document.getElementById('weeklyWorkouts');
            const todaysWorkoutContainer = document.getElementById('todaysWorkoutContent');
            const todayDayNameSpan = document.getElementById('todayDayName');
            const mealEntriesContainer = document.getElementById('mealEntries');
            const workoutChartContainer = document.getElementById('workoutChart');
            const progressStatsContainer = document.getElementById('progressStats');
            const progressChartContainer = document.getElementById('progressWorkoutChart');
            const workoutChartDetailPopup = document.getElementById('chartWorkoutDetail');
            const progressChartDetailPopup = document.getElementById('chartProgressDetail');

            // Planner Form Elements
            const editWorkoutIdInput = document.getElementById('editWorkoutId');
            const formTitle = document.getElementById('formTitle');
            const weekdaySelect = document.getElementById('weekdaySelect');
            const exerciseNameInput = document.getElementById('exerciseName');
            const exerciseDurationInput = document.getElementById('exerciseDuration');
            const exerciseSetsInput = document.getElementById('exerciseSets');
            const saveWorkoutBtn = document.getElementById('saveWorkoutBtn');
            const cancelEditWorkoutBtn = document.getElementById('cancelEditWorkoutBtn');
            const editMealIdInput = document.getElementById('editMealId');
            const mealNameInput = document.getElementById('mealName');
            const mealCaloriesInput = document.getElementById('mealCalories');
            const mealProteinInput = document.getElementById('mealProtein');
            const mealDateInput = document.getElementById('mealDate');
            const saveMealBtn = document.getElementById('saveMealBtn');
            const cancelEditMealBtn = document.getElementById('cancelEditMealBtn');

            // Planner State
            let workouts = [];
            let meals = [];
            let currentEditWorkoutId = null;
            let currentEditMealId = null;
            let activeChartPopupElement = null;

            // ==================================================
            // --- Shared Utilities ---
            // ==================================================
            function escapeHTML(str) {
                if (typeof str !== 'string') return '';
                const map = {'&': '&', '<': '<', '>': '>', '"': '"', "'": "'"};
                return str.replace(/[&<>"']/g, m => map[m]);
            }
            
            function getCurrentDayName() {
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                return days[new Date().getDay()];
            }
            
            function getStartOfWeek(date = new Date()) {
                const d = new Date(date);
                d.setDate(d.getDate() - d.getDay());
                d.setHours(0, 0, 0, 0);
                return d;
            }
            
            function calculateAverage(items, key) {
                if (!items?.length) return 0;
                const total = items.reduce((sum, item) => sum + (parseFloat(item[key]) || 0), 0);
                return total / items.length;
            }

            // ==================================================
            // --- FitLife Planner Logic ---
            // ==================================================

            // --- Planner Data Storage ---
            const storePlannerData = (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (error) {
                    console.error(`Error saving ${key}:`, error);
                }
            };
            
            const loadPlannerData = () => {
                try {
                    workouts = JSON.parse(localStorage.getItem('workouts')) || [];
                } catch (error) {
                    console.error("Error loading workouts:", error);
                    workouts = [];
                }
                
                try {
                    meals = JSON.parse(localStorage.getItem('meals')) || [];
                } catch (error) {
                    console.error("Error loading meals:", error);
                    meals = [];
                }
            };

            // --- Planner Navigation ---
            sidebarNav.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && e.target.dataset.section) {
                    showPlannerSection(e.target.dataset.section);
                }
            });
            
            function showPlannerSection(sectionId) {
                sections.forEach(section => section.classList.remove('active'));
                const activeSection = document.getElementById(sectionId);
                
                if (activeSection) {
                    activeSection.classList.add('active');
                    clearChartPopups();
                    
                    switch(sectionId) {
                        case 'workout':
                            renderTodaysWorkoutPlan();
                            renderWorkoutChart();
                            break;
                        case 'meal':
                            renderMeals();
                            break;
                        case 'progress':
                            renderProgressStats();
                            renderProgressChart();
                            break;
                    }
                } else {
                    console.error("Section not found:", sectionId);
                }
            }

            // --- Planner Rendering Functions ---
            function renderWorkouts() {
                if (!weeklyWorkoutsContainer) return;
                
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const workoutsByDay = workouts.reduce((acc, workout) => {
                    (acc[workout.weekday] = acc[workout.weekday] || []).push(workout);
                    return acc;
                }, {});
                
                const openDays = new Set(
                    Array.from(weeklyWorkoutsContainer.querySelectorAll('.weekday-section.open'))
                        .map(el => el.dataset.day)
                );
                
                weeklyWorkoutsContainer.innerHTML = days.map(day => {
                    const dayExercises = workoutsByDay[day]?.sort((a, b) => a.id - b.id) || [];
                    const isOpen = openDays.has(day);
                    const exerciseHTML = dayExercises.length === 0 
                        ? '<p><em>No exercises planned for this day.</em></p>' 
                        : dayExercises.map(renderExerciseItemHTML).join('');
                    
                    return `
                        <div class="card weekday-section ${isOpen ? 'open' : ''}" data-day="${day}">
                            <h3>${day}</h3>
                            <div class="weekday-exercises">${exerciseHTML}</div>
                        </div>
                    `;
                }).join('');
            }
            
            function renderTodaysWorkoutPlan() {
                if (!todaysWorkoutContainer || !todayDayNameSpan) return;
                
                const currentDay = getCurrentDayName();
                todayDayNameSpan.textContent = currentDay;
                const todaysExercises = workouts
                    .filter(w => w.weekday === currentDay)
                    .sort((a, b) => a.id - b.id);
                
                if (todaysExercises.length === 0) {
                    todaysWorkoutContainer.innerHTML = `<p><em>Rest day or no workouts planned for today.</em></p>`;
                } else {
                    todaysWorkoutContainer.innerHTML = todaysExercises.map(renderExerciseItemHTML).join('');
                }
            }
            
            function renderExerciseItemHTML(exercise) {
                const completedDateStr = exercise.completed && exercise.completedDate 
                    ? `<small>Completed: ${new Date(exercise.completedDate).toLocaleDateString()}</small>` 
                    : '';
                const title = exercise.completed ? 'Mark as incomplete' : 'Mark as completed';
                
                return `
                    <div class="exercise-item ${exercise.completed ? 'completed' : ''}" data-id="${exercise.id}">
                        <div class="exercise-details">
                            <h4>${escapeHTML(exercise.name ?? 'Unnamed Exercise')}</h4>
                            <p>Duration: ${exercise.duration ?? 0} mins</p>
                            <p>Sets/Reps: ${escapeHTML(exercise.setsReps ?? 'N/A')}</p>
                            ${completedDateStr}
                        </div>
                        <div class="item-actions">
                            <input type="checkbox" class="complete-checkbox" ${exercise.completed ? 'checked' : ''} title="${title}">
                            <button class="action-btn edit-btn" title="Edit exercise">Edit</button>
                            <button class="action-btn delete-btn" title="Delete exercise">Delete</button>
                        </div>
                    </div>
                `;
            }
            
            function renderRelevantCharts() {
                if (document.getElementById('workout')?.classList.contains('active')) renderWorkoutChart();
                if (document.getElementById('progress')?.classList.contains('active')) {
                    renderProgressChart();
                    renderProgressStats();
                }
            }
            
            function renderMeals() {
                if (!mealEntriesContainer) return;
                
                const sortedMeals = [...meals].sort((a, b) => {
                    const dateDiff = new Date(b.date) - new Date(a.date);
                    return dateDiff === 0 ? b.id - a.id : dateDiff;
                });
                
                mealEntriesContainer.innerHTML = sortedMeals.map(meal => {
                    const dateString = meal.date || new Date().toISOString().split('T')[0];
                    const mealLocalDate = new Date(dateString + 'T00:00:00Z');
                    const displayDate = mealLocalDate.toLocaleDateString(undefined, {
                        timeZone: 'UTC',
                        year: 'numeric',
                        month: 'numeric',
                        day: 'numeric'
                    });
                    
                    return `
                        <div class="meal-item" data-id="${meal.id}">
                            <div class="meal-details">
                                <h4>${escapeHTML(meal.name ?? 'Unnamed Meal')} <span>(${displayDate})</span></h4>
                                <p>Calories: ${meal.calories ?? 0} kcal</p>
                                <p>Protein: ${(meal.protein ?? 0).toFixed(1)} g</p>
                            </div>
                            <div class="item-actions">
                                <button class="action-btn edit-btn" title="Edit meal">Edit</button>
                                <button class="action-btn delete-btn" title="Delete meal">Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                if (meals.length === 0) {
                    mealEntriesContainer.innerHTML = '<p><em>No meals logged yet. Add one above!</em></p>';
                }
            }
            
            function renderProgressStats() {
                if (!progressStatsContainer) return;
                
                const totalPlanned = workouts.length;
                const completed = workouts.filter(w => w.completed);
                const totalCompleted = completed.length;
                const totalMinutes = completed.reduce((sum, w) => sum + (parseInt(w.duration) || 0), 0);
                const totalMeals = meals.length;
                const avgCal = calculateAverage(meals, 'calories');
                const avgProt = calculateAverage(meals, 'protein');
                
                progressStatsContainer.innerHTML = `
                    <h4>Workout Stats</h4>
                    <p>Total Exercises Planned: <strong>${totalPlanned}</strong></p>
                    <p>Completed Exercises: <strong>${totalCompleted}</strong></p>
                    <p>Total Workout Time (Completed): <strong>${totalMinutes} minutes</strong></p>
                    <hr>
                    <h4>Nutrition Stats</h4>
                    <p>Total Meals Logged: <strong>${totalMeals}</strong></p>
                    ${totalMeals > 0 ? `<p>Average Calories / Meal: <strong>${avgCal.toFixed(0)} kcal</strong></p>` : ''}
                    ${totalMeals > 0 ? `<p>Average Protein / Meal: <strong>${avgProt.toFixed(1)} g</strong></p>` : ''}
                `;
            }

            // --- Planner Event Handlers & Actions ---
            workoutForm.addEventListener('submit', handleWorkoutFormSubmit);
            cancelEditWorkoutBtn?.addEventListener('click', resetWorkoutForm);
            workoutSectionContainer?.addEventListener('click', handleWorkoutSectionClick);
            mealForm.addEventListener('submit', handleMealFormSubmit);
            cancelEditMealBtn?.addEventListener('click', resetMealForm);
            mealEntriesContainer?.addEventListener('click', handleMealEntriesClick);
            
            [workoutChartContainer, progressChartContainer].forEach(container => {
                if (container) {
                    container.addEventListener('click', handlePlannerChartBarClick);
                    container.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') handlePlannerChartBarClick(e);
                    });
                }
            });

            function handleWorkoutFormSubmit(e) {
                e.preventDefault();
                
                const duration = parseInt(exerciseDurationInput.value);
                const name = exerciseNameInput.value.trim();
                const setsReps = exerciseSetsInput.value.trim();
                
                if (name === '') {
                    alert("Please enter an exercise name.");
                    exerciseNameInput.focus();
                    return;
                }
                
                if (isNaN(duration) || duration <= 0) {
                    alert("Please enter a valid positive number for duration.");
                    exerciseDurationInput.focus();
                    return;
                }
                
                if (setsReps === '') {
                    alert("Please enter sets/reps information.");
                    exerciseSetsInput.focus();
                    return;
                }
                
                const existingWorkout = currentEditWorkoutId 
                    ? workouts.find(w => w.id === currentEditWorkoutId)
                    : null;
                
                const workoutData = {
                    name,
                    duration,
                    setsReps,
                    weekday: weekdaySelect.value,
                    completed: existingWorkout?.completed ?? false,
                    completedDate: existingWorkout?.completedDate ?? null,
                    id: currentEditWorkoutId || Date.now()
                };
                
                if (currentEditWorkoutId) {
                    const index = workouts.findIndex(w => w.id === currentEditWorkoutId);
                    if (index > -1) {
                        workouts[index] = workoutData;
                    } else {
                        console.error("Couldn't find workout to update");
                    }
                } else {
                    workouts.push(workoutData);
                }
                
                storePlannerData('workouts', workouts);
                resetWorkoutForm();
                renderWorkouts();
                renderTodaysWorkoutPlan();
                renderRelevantCharts();
            }
            
            function resetWorkoutForm() {
                if (!workoutForm) return;
                
                workoutForm.reset();
                currentEditWorkoutId = null;
                
                if (editWorkoutIdInput) editWorkoutIdInput.value = '';
                if (formTitle) formTitle.textContent = 'Add Exercise';
                if (saveWorkoutBtn) saveWorkoutBtn.textContent = 'Add Exercise';
                if (cancelEditWorkoutBtn) cancelEditWorkoutBtn.style.display = 'none';
            }
            
            function handleWorkoutSectionClick(e) {
                const target = e.target;
                const exerciseItem = target.closest('.exercise-item');
                const weekdayHeader = target.closest('#weeklyWorkouts .weekday-section h3');
                const weekdaySection = target.closest('#weeklyWorkouts .weekday-section');
                
                if (weekdayHeader && weekdaySection) {
                    weekdaySection.classList.toggle('open');
                    return;
                }
                
                if (exerciseItem?.dataset.id) {
                    const workoutId = parseInt(exerciseItem.dataset.id);
                    
                    if (target.classList.contains('edit-btn')) {
                        startEditWorkout(workoutId);
                    } else if (target.classList.contains('delete-btn')) {
                        deleteWorkout(workoutId);
                    } else if (target.classList.contains('complete-checkbox')) {
                        toggleWorkoutComplete(workoutId, target.checked);
                    }
                }
            }
            
            function startEditWorkout(id) {
                const workout = workouts.find(w => w.id === id);
                if (!workout) return console.error("Workout not found:", id);
                
                const accordionSectionElement = weeklyWorkoutsContainer?.querySelector(
                    `.weekday-section[data-day="${workout.weekday}"]`
                );
                
                if (accordionSectionElement && !accordionSectionElement.classList.contains('open')) {
                    accordionSectionElement.classList.add('open');
                }
                
                currentEditWorkoutId = id;
                editWorkoutIdInput.value = id;
                weekdaySelect.value = workout.weekday;
                exerciseNameInput.value = workout.name ?? '';
                exerciseDurationInput.value = workout.duration ?? '';
                exerciseSetsInput.value = workout.setsReps ?? '';
                
                formTitle.textContent = 'Edit Exercise';
                saveWorkoutBtn.textContent = 'Update Exercise';
                cancelEditWorkoutBtn.style.display = 'inline-block';
                
                workoutForm?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                exerciseNameInput?.focus();
            }
            
            function deleteWorkout(id) {
                if (confirm('Are you sure you want to delete this exercise?')) {
                    workouts = workouts.filter(w => w.id !== id);
                    storePlannerData('workouts', workouts);
                    renderWorkouts();
                    renderTodaysWorkoutPlan();
                    renderRelevantCharts();
                    clearChartPopups();
                }
            }
            
            function toggleWorkoutComplete(id, isCompleted) {
                const index = workouts.findIndex(w => w.id === id);
                
                if (index > -1) {
                    workouts[index].completed = isCompleted;
                    workouts[index].completedDate = isCompleted ? new Date().toISOString() : null;
                    storePlannerData('workouts', workouts);
                    renderWorkouts();
                    renderTodaysWorkoutPlan();
                    renderRelevantCharts();
                } else {
                    console.error("Workout not found for toggle:", id);
                }
            }
            
            function handleMealFormSubmit(e) {
                e.preventDefault();
                
                const calories = parseFloat(mealCaloriesInput.value);
                const protein = parseFloat(mealProteinInput.value);
                const name = mealNameInput.value.trim();
                const date = mealDateInput.value;
                
                if (name === '') {
                    alert("Please enter a meal name.");
                    mealNameInput.focus();
                    return;
                }
                
                if (isNaN(calories)) {
                    alert("Enter valid calories.");
                    mealCaloriesInput.focus();
                    return;
                }
                
                if (isNaN(protein)) {
                    alert("Enter valid protein.");
                    mealProteinInput.focus();
                    return;
                }
                
                if (!date) {
                    alert("Select a date.");
                    mealDateInput.focus();
                    return;
                }
                
                const mealData = {
                    name,
                    calories,
                    protein,
                    date,
                    id: currentEditMealId || Date.now()
                };
                
                if (currentEditMealId) {
                    const index = meals.findIndex(m => m.id === currentEditMealId);
                    if (index > -1) meals[index] = mealData;
                } else {
                    meals.push(mealData);
                }
                
                storePlannerData('meals', meals);
                resetMealForm();
                renderMeals();
                
                if (document.getElementById('progress')?.classList.contains('active')) {
                    renderProgressStats();
                }
            }
            
            function resetMealForm() {
                if (!mealForm) return;
                
                mealForm.reset();
                currentEditMealId = null;
                
                if (editMealIdInput) editMealIdInput.value = '';
                if (saveMealBtn) saveMealBtn.textContent = 'Add Meal';
                if (cancelEditMealBtn) cancelEditMealBtn.style.display = 'none';
                if (mealDateInput) mealDateInput.valueAsDate = new Date();
            }
            
            function handleMealEntriesClick(e) {
                const target = e.target;
                const mealItem = target.closest('.meal-item');
                
                if (!mealItem?.dataset.id) return;
                
                const mealId = parseInt(mealItem.dataset.id);
                
                if (target.classList.contains('edit-btn')) {
                    startEditMeal(mealId);
                } else if (target.classList.contains('delete-btn')) {
                    deleteMeal(mealId);
                }
            }
            
            function startEditMeal(id) {
                const meal = meals.find(m => m.id === id);
                if (!meal) return;
                
                currentEditMealId = id;
                editMealIdInput.value = id;
                mealNameInput.value = meal.name ?? '';
                mealCaloriesInput.value = meal.calories ?? '';
                mealProteinInput.value = meal.protein ?? '';
                mealDateInput.value = meal.date ?? '';
                
                saveMealBtn.textContent = 'Update Meal';
                cancelEditMealBtn.style.display = 'inline-block';
                mealForm?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                mealNameInput?.focus();
            }
            
            function deleteMeal(id) {
                if (confirm('Delete this meal log?')) {
                    meals = meals.filter(m => m.id !== id);
                    storePlannerData('meals', meals);
                    renderMeals();
                    
                    if (document.getElementById('progress')?.classList.contains('active')) {
                        renderProgressStats();
                    }
                }
            }
            
            function handlePlannerChartBarClick(e) {
                const barWrapper = e.target.closest('.bar-wrapper');
                
                if (barWrapper?.dataset.dayIndex !== undefined) {
                    e.preventDefault();
                    const dayIndex = parseInt(barWrapper.dataset.dayIndex);
                    let targetPopupElement = null;
                    
                    if (e.currentTarget === workoutChartContainer) {
                        targetPopupElement = workoutChartDetailPopup;
                    } else if (e.currentTarget === progressChartContainer) {
                        targetPopupElement = progressChartDetailPopup;
                    }
                    
                    if (targetPopupElement) {
                        if (targetPopupElement.classList.contains('visible') && 
                            activeChartPopupElement === targetPopupElement && 
                            targetPopupElement.dataset.activeDayIndex == dayIndex) {
                            clearChartPopups();
                        } else {
                            showChartWorkoutDetails(dayIndex, targetPopupElement);
                        }
                    }
                }
            }
            
            function showChartWorkoutDetails(dayIndex, popupElement) {
                const daysOfWeekFull = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayName = daysOfWeekFull[dayIndex];
                const startOfWeek = getStartOfWeek();
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 7);
                
                const completedOnDay = workouts
                    .filter(w => w.completed && w.completedDate && 
                           new Date(w.completedDate).getDay() === dayIndex && 
                           new Date(w.completedDate) >= startOfWeek && 
                           new Date(w.completedDate) < endOfWeek)
                    .sort((a, b) => a.id - b.id);
                
                let content = `<h5>Completed on ${dayName}</h5><ul>`;
                
                if (completedOnDay.length === 0) {
                    content += `<li><em>None this week.</em></li>`;
                } else {
                    completedOnDay.forEach(w => {
                        content += `<li>${escapeHTML(w.name ?? '?')} (${w.duration ?? 0} min)</li>`;
                    });
                }
                
                content += `</ul>`;
                
                clearChartPopups();
                popupElement.innerHTML = content;
                popupElement.classList.add('visible');
                popupElement.dataset.activeDayIndex = dayIndex;
                activeChartPopupElement = popupElement;
            }
            
            function clearChartPopups() {
                [workoutChartDetailPopup, progressChartDetailPopup].forEach(popup => {
                    if (popup) {
                        popup.classList.remove('visible');
                        popup.removeAttribute('data-active-day-index');
                    }
                });
                
                activeChartPopupElement = null;
            }
            
            function renderWorkoutChart() {
                const labels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const data = Array(7).fill(0);
                const start = getStartOfWeek();
                const end = new Date(start);
                end.setDate(start.getDate() + 7);
                
                workouts.forEach(ex => {
                    if (ex.completed && ex.completedDate) {
                        try {
                            const d = new Date(ex.completedDate);
                            if (!isNaN(d) && d >= start && d < end) {
                                data[d.getDay()] += parseInt(ex.duration) || 0;
                            }
                        } catch (e) {
                            console.error("Invalid date found in workout:", ex.completedDate);
                        }
                    }
                });
                
                renderGenericChart(workoutChartContainer, data, labels, 'm', 'workout');
            }
            
            function renderProgressChart() {
                const labels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const data = Array(7).fill(0);
                const start = getStartOfWeek();
                const end = new Date(start);
                end.setDate(start.getDate() + 7);
                
                workouts.forEach(ex => {
                    if (ex.completed && ex.completedDate) {
                        try {
                            const d = new Date(ex.completedDate);
                            if (!isNaN(d) && d >= start && d < end) {
                                data[d.getDay()] += parseInt(ex.duration) || 0;
                            }
                        } catch(e) {
                            console.error("Invalid date found in workout:", ex.completedDate);
                        }
                    }
                });
                
                renderGenericChart(progressChartContainer, data, labels, 'm', 'progress');
            }
            
            function renderGenericChart(container, data, labels, unit = '', chartId = '') {
                if (!container) return console.error("Chart container missing for", chartId);
                
                container.innerHTML = '';
                const maxVal = Math.max(...data, 1);
                
                labels.forEach((label, index) => {
                    const value = data[index] || 0;
                    const height = Math.min(Math.max((value / maxVal) * 100, 0), 100);
                    
                    const wrapper = document.createElement('div');
                    wrapper.className = 'bar-wrapper';
                    wrapper.dataset.dayIndex = index;
                    if (chartId) wrapper.dataset.chartId = chartId;
                    wrapper.setAttribute('role', 'button');
                    wrapper.setAttribute('aria-label', `${labels[index]}: ${value}${unit}`);
                    wrapper.setAttribute('tabindex', '0');
                    
                    const bar = document.createElement('div');
                    bar.className = 'bar';
                    bar.style.height = `max(${height}%, 2px)`;
                    
                    const valEl = document.createElement('div');
                    valEl.className = 'bar-value';
                    valEl.textContent = value > 0 ? `${value}${unit}` : '';
                    
                    const labelEl = document.createElement('div');
                    labelEl.className = 'bar-label';
                    labelEl.textContent = label;
                    
                    wrapper.appendChild(valEl);
                    wrapper.appendChild(bar);
                    wrapper.appendChild(labelEl);
                    container.appendChild(wrapper);
                });
            }

            // ==================================================
            // --- FitBot Chatbot Logic ---
            // ==================================================

            // --- Chatbot Event Listeners ---
            chatToggleButton?.addEventListener('click', () => toggleChatWidget());
            closeChatButton?.addEventListener('click', () => toggleChatWidget(false));
            sendButton?.addEventListener('click', sendChatMessage);
            
            userInput?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
            
            userInput?.addEventListener('input', adjustChatInputHeight);

            // --- Chatbot Functions ---
            function toggleChatWidget(forceState) {
                if (!chatWidget) return;
                
                const isActive = chatWidget.classList.contains('active');
                const shouldBeActive = forceState !== undefined ? forceState : !isActive;
                
                if (shouldBeActive) {
                    chatWidget.classList.add('active');
                    userInput?.focus();
                } else {
                    chatWidget.classList.remove('active');
                }
            }

            function displayChatMessage(message, sender) {
                if (!chatBody) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', `${sender}-message`);

                // Basic text sanitation & remove markdown asterisks
                let safeMessage = escapeHTML(message).replace(/\*/g, "");
                // Convert newlines preserved by API to <br> tags for HTML display
                safeMessage = safeMessage.replace(/\n/g, '<br>');

                messageDiv.innerHTML = safeMessage; // Use innerHTML for <br> tags

                removeTypingIndicator();
                chatBody.appendChild(messageDiv);
                scrollChatToBottom();
            }

            function showTypingIndicator() {
                removeTypingIndicator(); // Remove old one first
                if (!chatBody) return;
                
                const typingDiv = document.createElement('div');
                typingDiv.classList.add('typing-indicator');
                typingDiv.textContent = 'FitBot is typing...';
                chatBody.appendChild(typingDiv);
                scrollChatToBottom();
            }
            
            function removeTypingIndicator() {
                const indicator = chatBody?.querySelector('.typing-indicator');
                if (indicator) indicator.remove();
            }

            function scrollChatToBottom() {
                setTimeout(() => {
                    chatBody?.scrollTo({
                        top: chatBody.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 50);
            }

            function adjustChatInputHeight() {
                if (!userInput) return;
                
                userInput.style.height = 'auto'; // Reset height
                let scrollHeight = userInput.scrollHeight;
                const maxHeight = 100; // Max height in pixels before scrolling
                
                if (scrollHeight > maxHeight) {
                    userInput.style.height = `${maxHeight}px`;
                    userInput.style.overflowY = 'auto';
                } else {
                    // Add a pixel to prevent single-line jumpiness
                    userInput.style.height = `${scrollHeight + (userInput.value ? 1 : 0)}px`;
                    userInput.style.overflowY = 'hidden';
                }
            }

            async function sendChatMessage() {
                if (!userInput || !API_URL) return;
                
                const userMessage = userInput.value.trim();
                if (!userMessage) return;

                // --- CRITICAL: API Key Check ---
                if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_API_KEY_HERE") {
                    console.error("CRITICAL SECURITY WARNING: Gemini API Key is missing or still set to the placeholder 'YOUR_API_KEY_HERE' in the script. Bot will not function. Please replace it for local testing and USE A BACKEND PROXY for deployment.");
                    displayChatMessage("⚠️ Error: Bot not configured. API Key is missing. (Check browser console for details)", "bot");
                    return; // Stop execution if key is missing/placeholder
                }
                // --- End Key Check ---

                displayChatMessage(userMessage, 'user');
                chatHistory.push({
                    role: "user",
                    parts: [{ text: userMessage }]
                });

                userInput.value = '';
                adjustChatInputHeight();
                showTypingIndicator();

                // --- Prepare payload with history ---
                const historyToSend = chatHistory.slice(-MAX_HISTORY_TURNS * 2);
                const payload = {
                    contents: [
                        { role: "user", parts: [{ text: systemPrompt }]},
                        { role: "model", parts: [{ text: "Okay, I understand the instructions. I am FitBot, ready to help with fitness!"}]},
                        ...historyToSend
                    ],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 1500
                    }
                };
                
                // Remove system prompt from contents if using top level systemInstruction
                delete payload.contents[0];
                delete payload.contents[0];

                try {
                    console.log("Sending payload:", JSON.stringify(payload, null, 2));

                    const response = await fetch(API_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        let errorMsg = `API Error (${response.status}): ${response.statusText}`;
                        let errorDetails = {};
                        
                        try {
                            errorDetails = await response.json();
                            errorMsg += `\nDetails: ${JSON.stringify(errorDetails)}`;
                        } catch {}
                        
                        console.error(errorMsg, errorDetails);
                        throw new Error(`API request failed (${response.status}). Check console for details.`);
                    }

                    const data = await response.json();
                    removeTypingIndicator();

                    console.log("API Response data:", data);

                    // Extract text, checking different possible locations
                    let botResponseText = data?.candidates?.[0]?.content?.parts?.[0]?.text;

                    // Check for block reason
                    if (!botResponseText && data?.candidates?.[0]?.finishReason === 'SAFETY') {
                        console.warn("Response blocked due to safety settings.");
                        botResponseText = "I can't respond to that due to safety guidelines. Can we focus on fitness?";
                    } else if (!botResponseText) {
                        console.warn("Received empty or unexpected response structure:", data);
                        botResponseText = "Sorry, I had trouble understanding that. Could you please rephrase?";
                    }

                    displayChatMessage(botResponseText, 'bot');
                    chatHistory.push({
                        role: "model",
                        parts: [{ text: botResponseText }]
                    });

                    // Prune history: Keep only the last N turns
                    if (chatHistory.length > MAX_HISTORY_TURNS * 2) {
                        chatHistory = chatHistory.slice(-MAX_HISTORY_TURNS * 2);
                    }

                } catch (error) {
                    console.error("Error sending/receiving chat message:", error);
                    removeTypingIndicator();
                    displayChatMessage(`Connection error: ${error.message || 'Could not reach FitBot.'}. Check console for details.`, 'bot');
                }
            }

            // ==================================================
            // --- Initial Application Load ---
            // ==================================================
            function initializeApp() {
                loadPlannerData();
                renderMeals();
                renderWorkouts();
                renderTodaysWorkoutPlan();
                showPlannerSection('workout');
            }

            initializeApp();

            // Global listener to close planner chart popups when clicking outside
            document.body.addEventListener('click', (e) => {
                if (!e.target.closest('.chart-container') && !e.target.closest('.chart-detail-popup.visible')) {
                    clearChartPopups();
                }
            }, true);
        });
    </script>
</body>
</html>
